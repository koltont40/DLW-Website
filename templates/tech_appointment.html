{% extends "base.html" %}
{% block title %}{{ appointment.title }} | Field Portal{% endblock %}
{% block content %}
<div class="tech-appointment">
  <header class="tech-section-header">
    <div>
      <a class="inline-link" href="{{ url_for('tech_dashboard') }}">← Back to dashboard</a>
      <h1>{{ appointment.client.name }}</h1>
      <p class="subtle">{{ appointment.title }} • {{ appointment.scheduled_for.strftime('%b %d, %Y %I:%M %p') }} • {{ appointment.status }}</p>
    </div>
    <div class="tech-header-actions">
      <a class="button secondary" href="{{ url_for('tech_logout') }}">Sign out</a>
    </div>
  </header>
  {% if client.address %}
  <section class="tech-section">
    <header class="tech-section-header">
      <div>
        <h2>Navigate to the customer</h2>
        <p class="subtle">{{ client.address }}</p>
      </div>
    </header>
    <div class="tech-navigation-actions">
      <a
        class="button secondary"
        href="https://maps.apple.com/?daddr={{ client.address | urlencode }}"
        target="_blank"
        rel="noopener"
      >
        Open in Apple Maps
      </a>
      <a
        class="button secondary"
        href="https://www.google.com/maps/dir/?api=1&destination={{ client.address | urlencode }}"
        target="_blank"
        rel="noopener"
      >
        Open in Google Maps
      </a>
    </div>
  </section>
  {% endif %}
  <section class="tech-section">
    <header class="tech-section-header">
      <div>
        <h2>Upload documentation</h2>
        <p class="subtle">Capture clear photos for each required category before closing the job.</p>
      </div>
    </header>
    <form
      class="stacked-form tech-upload-form"
      method="post"
      action="{{ url_for('upload_install_photo_technician', client_id=client.id) }}"
      enctype="multipart/form-data"
    >
      <input type="hidden" name="appointment_id" value="{{ appointment.id }}" />
      <input type="hidden" name="next" value="{{ request.path }}" />
      <label>
        Photo category
        <select name="category">
          {% for category in photo_categories %}
          <option value="{{ category }}" {% if missing_categories and category == missing_categories[0] %}selected{% endif %}>{{ category }}</option>
          {% endfor %}
        </select>
      </label>
      <label>
        Photo file
        <input type="file" name="photo" accept="image/*" required />
      </label>
      <label>
        Notes
        <textarea name="notes" rows="2" placeholder="Location, orientation, or install details"></textarea>
      </label>
      <button class="button primary" type="submit">Upload photo</button>
    </form>
  </section>
  <section class="tech-section">
    <header class="tech-section-header">
      <div>
        <h2>Progress checklist</h2>
        <p class="subtle">All categories must be captured to complete the visit.</p>
      </div>
    </header>
    <div class="tech-checklist">
      {% for category in required_categories %}
      <article class="tech-checklist-item {% if photos_by_category.get(category) %}complete{% endif %}">
        <h3>{{ category }}</h3>
        {% if photos_by_category.get(category) %}
        <div class="tech-photo-strip">
          {% for photo in photos_by_category.get(category) %}
          <a href="{{ url_for('serve_install_photo', photo_id=photo.id) }}" target="_blank">
            <img src="{{ url_for('serve_install_photo', photo_id=photo.id) }}" alt="{{ category }} photo" />
          </a>
          {% endfor %}
        </div>
        {% else %}
        <p class="subtle">No photo uploaded yet.</p>
        {% endif %}
      </article>
      {% endfor %}
    </div>
  </section>
  <section class="tech-section">
    <header class="tech-section-header">
      <div>
        <h2>Customer acknowledgement</h2>
        <p class="subtle">Capture the customer signature confirming they reviewed the AUP, Privacy Policy, and Terms of Service.</p>
      </div>
    </header>
    {% if acknowledgement %}
    <div class="acknowledgement-summary">
      <p class="subtle">Last signed by {{ acknowledgement.signed_name }} on {{ acknowledgement.signed_at.strftime('%b %d, %Y %I:%M %p') }}.</p>
      <img src="{{ url_for('serve_install_signature', ack_id=acknowledgement.id) }}" alt="Customer signature" />
    </div>
    {% endif %}
    <form class="stacked-form signature-form" id="signature-form" method="post" action="{{ url_for('submit_install_acknowledgement', appointment_id=appointment.id) }}">
      <label>
        Printed name
        <input type="text" name="signed_name" placeholder="Customer name" required />
      </label>
      <div class="signature-canvas-wrapper">
        <canvas id="signature-pad" width="640" height="220"></canvas>
        <div class="signature-actions">
          <button class="button small secondary" type="button" id="clear-signature">Clear signature</button>
        </div>
      </div>
      <fieldset class="policy-checklist">
        <legend>Customer confirmed:</legend>
        <label>
          <input type="checkbox" name="accept_aup" required />
          Acceptable Use Policy
          {% if legal_documents['aup'] %}
          <a class="inline-link" href="{{ url_for('view_document', doc_type='aup') }}" target="_blank" rel="noopener">Review</a>
          {% else %}
          <span class="subtle">(Upload the AUP in the admin dashboard)</span>
          {% endif %}
        </label>
        <label>
          <input type="checkbox" name="accept_privacy" required />
          Privacy Policy
          {% if legal_documents['privacy'] %}
          <a class="inline-link" href="{{ url_for('view_document', doc_type='privacy') }}" target="_blank" rel="noopener">Review</a>
          {% else %}
          <span class="subtle">(Upload the Privacy Policy in the admin dashboard)</span>
          {% endif %}
        </label>
        <label>
          <input type="checkbox" name="accept_tos" required />
          Terms of Service
          {% if legal_documents['tos'] %}
          <a class="inline-link" href="{{ url_for('view_document', doc_type='tos') }}" target="_blank" rel="noopener">Review</a>
          {% else %}
          <span class="subtle">(Upload the Terms of Service in the admin dashboard)</span>
          {% endif %}
        </label>
      </fieldset>
      <input type="hidden" name="signature_data" id="signature-data" />
      <button class="button primary" type="submit">Save acknowledgement</button>
    </form>
  </section>
</div>
<script>
  document.addEventListener('DOMContentLoaded', () => {
    const canvas = document.getElementById('signature-pad');
    const form = document.getElementById('signature-form');
    const clearButton = document.getElementById('clear-signature');
    const signatureInput = document.getElementById('signature-data');
    if (!canvas || !form || !clearButton || !signatureInput) {
      return;
    }

    const ctx = canvas.getContext('2d');
    let drawing = false;
    let hasSignature = false;

    ctx.lineWidth = 2.5;
    ctx.lineJoin = 'round';
    ctx.lineCap = 'round';
    ctx.strokeStyle = getComputedStyle(canvas).getPropertyValue('--secondary') || '#f5f3ff';

    const getPoint = (event) => {
      const rect = canvas.getBoundingClientRect();
      const scaleX = canvas.width / rect.width;
      const scaleY = canvas.height / rect.height;
      if (event.touches && event.touches.length > 0) {
        return {
          x: (event.touches[0].clientX - rect.left) * scaleX,
          y: (event.touches[0].clientY - rect.top) * scaleY,
        };
      }
      return {
        x: (event.clientX - rect.left) * scaleX,
        y: (event.clientY - rect.top) * scaleY,
      };
    };

    const startDrawing = (event) => {
      event.preventDefault();
      drawing = true;
      hasSignature = true;
      const point = getPoint(event);
      ctx.beginPath();
      ctx.moveTo(point.x, point.y);
    };

    const draw = (event) => {
      if (!drawing) {
        return;
      }
      event.preventDefault();
      const point = getPoint(event);
      ctx.lineTo(point.x, point.y);
      ctx.stroke();
    };

    const endDrawing = (event) => {
      if (!drawing) {
        return;
      }
      event.preventDefault();
      drawing = false;
      ctx.closePath();
    };

    const clearSignature = () => {
      ctx.clearRect(0, 0, canvas.width, canvas.height);
      hasSignature = false;
      signatureInput.value = '';
    };

    canvas.addEventListener('mousedown', startDrawing);
    canvas.addEventListener('mousemove', draw);
    canvas.addEventListener('mouseup', endDrawing);
    canvas.addEventListener('mouseleave', endDrawing);
    canvas.addEventListener('touchstart', startDrawing, { passive: false });
    canvas.addEventListener('touchmove', draw, { passive: false });
    canvas.addEventListener('touchend', endDrawing);
    canvas.addEventListener('touchcancel', endDrawing);

    clearButton.addEventListener('click', (event) => {
      event.preventDefault();
      clearSignature();
    });

    form.addEventListener('submit', (event) => {
      if (!hasSignature) {
        event.preventDefault();
        alert('Capture the customer signature before saving.');
        return;
      }
      signatureInput.value = canvas.toDataURL('image/png');
    });
  });
</script>
{% endblock %}
