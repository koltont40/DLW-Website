{% extends "base.html" %}
{% block title %}Admin Dashboard | DIXIELAND WIRELESS LLC{% endblock %}
{% block content %}
<div class="dashboard-layout">
  <aside class="admin-sidebar">
    <div class="sidebar-header">
      <h1>Admin Control Center</h1>
      <p class="subtle">Command every facet of DIXIELAND WIRELESS LLC from one dark-mode cockpit.</p>
    </div>
    <nav class="sidebar-nav">
      <div class="sidebar-group">
        <span class="sidebar-group-label">Snapshot</span>
        <a class="sidebar-link {% if active_section == 'overview' %}active{% endif %}" href="{{ url_for('dashboard', section='overview') }}">Operations</a>
      </div>
      <div class="sidebar-group">
        <span class="sidebar-group-label">Customer Ops</span>
        <a class="sidebar-link {% if active_section == 'customers' %}active{% endif %}" href="{{ url_for('dashboard', section='customers') }}">Customers</a>
        <a class="sidebar-link {% if active_section == 'portal' %}active{% endif %}" href="{{ url_for('dashboard', section='portal') }}">Portal Access</a>
        <a class="sidebar-link {% if active_section == 'billing' %}active{% endif %}" href="{{ url_for('dashboard', section='billing') }}">Billing</a>
        <a class="sidebar-link {% if active_section == 'network' %}active{% endif %}" href="{{ url_for('dashboard', section='network') }}">Network</a>
        <a class="sidebar-link {% if active_section == 'appointments' %}active{% endif %}" href="{{ url_for('dashboard', section='appointments') }}">Appointments</a>
        <a class="sidebar-link {% if active_section == 'support' %}active{% endif %}" href="{{ url_for('dashboard', section='support') }}">Support</a>
        <a class="sidebar-link {% if active_section == 'field' %}active{% endif %}" href="{{ url_for('dashboard', section='field') }}">Field Ops</a>
      </div>
      <div class="sidebar-group">
        <span class="sidebar-group-label">Site Experience</span>
        <a class="sidebar-link {% if active_section == 'plans' %}active{% endif %}" href="{{ url_for('dashboard', section='plans') }}">Service Plans</a>
        <a class="sidebar-link {% if active_section == 'navigation' %}active{% endif %}" href="{{ url_for('dashboard', section='navigation') }}">Header Links</a>
        <a class="sidebar-link {% if active_section == 'branding' %}active{% endif %}" href="{{ url_for('dashboard', section='branding') }}">Branding</a>
        <a class="sidebar-link {% if active_section == 'blog' %}active{% endif %}" href="{{ url_for('dashboard', section='blog') }}">Blog</a>
        <a class="sidebar-link {% if active_section == 'legal' %}active{% endif %}" href="{{ url_for('dashboard', section='legal') }}">Legal</a>
      </div>
    </nav>
    <div class="sidebar-footer">
      <a class="button secondary" href="{{ url_for('logout') }}">Log out</a>
    </div>
  </aside>
  <div class="dashboard-main">
    {% if active_section == 'overview' %}
    <section class="card status-card" id="overview">
      <header class="section-header">
        <div>
          <h2>Operations Snapshot</h2>
          <p class="subtle">Real-time visibility across customers, network, support, and billing.</p>
        </div>
      </header>
      <div class="snapshot-grid">
        {% for category in operations_snapshot %}
        <article class="snapshot-tile">
          <header>
            <h3>{{ category.title }}</h3>
            <p class="subtle">{{ category.description }}</p>
          </header>
          <ul class="metric-list">
            {% for metric in category.metrics %}
            <li>
              <span class="metric-label">{{ metric.label }}</span>
              <span class="metric-value">
                {% if metric.format == 'currency' %}
                {{ metric.value|currency }}
                {% else %}
                {{ metric.value }}
                {% endif %}
              </span>
            </li>
            {% endfor %}
          </ul>
          {% if category.footer %}
          <p class="snapshot-footer">{{ category.footer }}</p>
          {% endif %}
        </article>
        {% endfor %}
      </div>
      <div class="snapshot-panels">
        <article class="status-panel">
          <header>
            <h3>Customer Activity</h3>
            <p class="subtle">Latest signups and account changes.</p>
          </header>
          {% if recent_clients %}
          <ul class="status-list">
            {% for customer in recent_clients %}
            <li>
              <div class="status-primary">
                <strong>{{ customer.name }}</strong>
                <span class="subtle">{{ customer.created_at.strftime('%b %d, %Y') }}</span>
              </div>
              <div class="status-secondary">
                <span>{{ customer.status }}</span>
                <span class="subtle">{{ customer.service_summary or 'Service TBD' }}</span>
              </div>
            </li>
            {% endfor %}
          </ul>
          {% else %}
          <p class="subtle">No customers yet. Encourage prospects to complete the signup form.</p>
          {% endif %}
        </article>
        <article class="status-panel">
          <header>
            <h3>Billing Pulse</h3>
            <p class="subtle">Monitor invoices landing across the fleet.</p>
          </header>
          {% if recent_invoices %}
          <ul class="status-list">
            {% for invoice in recent_invoices %}
            <li>
              <div class="status-primary">
                <strong>{{ invoice.description }}</strong>
                <span class="badge">{{ invoice.status }}</span>
              </div>
              <div class="status-secondary">
                <span>{{ invoice.amount_cents|currency }}</span>
                <span class="subtle">{{ invoice.client.name if invoice.client else 'Unassigned' }}</span>
              </div>
            </li>
            {% endfor %}
          </ul>
          {% else %}
          <p class="subtle">Post an invoice to start tracking billing momentum.</p>
          {% endif %}
        </article>
        <article class="status-panel">
          <header>
            <h3>Network Deployments</h3>
            <p class="subtle">Recent equipment placed in the field.</p>
          </header>
          {% if recent_equipment %}
          <ul class="status-list">
            {% for device in recent_equipment %}
            <li>
              <div class="status-primary">
                <strong>{{ device.name }}</strong>
                <span class="subtle">{{ device.created_at.strftime('%b %d, %Y') }}</span>
              </div>
              <div class="status-secondary">
                <span>{{ device.model or 'Model pending' }}</span>
                <span class="subtle">{{ device.client.name if device.client else 'Unassigned' }}</span>
              </div>
            </li>
            {% endfor %}
          </ul>
          {% else %}
          <p class="subtle">Log your first install to populate the network timeline.</p>
          {% endif %}
        </article>
        <article class="status-panel">
          <header>
            <h3>Field Appointments</h3>
            <p class="subtle">Upcoming visits and client responses.</p>
          </header>
          {% if upcoming_appointments %}
          <ul class="status-list">
            {% for appointment in upcoming_appointments %}
            <li>
              <div class="status-primary">
                <strong>{{ appointment.title }}</strong>
                <span class="badge">{{ appointment.status }}</span>
              </div>
              <div class="status-secondary">
                <span>{{ appointment.client.name if appointment.client else 'Unassigned' }}</span>
                <span class="subtle">{{ appointment.scheduled_for.strftime('%b %d, %Y %I:%M %p') }}</span>
              </div>
            </li>
            {% endfor %}
          </ul>
          {% else %}
          <p class="subtle">No field appointments are on the calendar.</p>
          {% endif %}
        </article>
        <article class="status-panel">
          <header>
            <h3>Support Signals</h3>
            <p class="subtle">Ticket velocity from subscribers.</p>
          </header>
          {% if recent_tickets %}
          <ul class="status-list">
            {% for ticket in recent_tickets %}
            <li>
              <div class="status-primary">
                <strong>{{ ticket.subject }}</strong>
                <span class="badge">{{ ticket.status }}</span>
              </div>
              <div class="status-secondary">
                <span>{{ ticket.client.name if ticket.client else 'Unknown client' }}</span>
                <span class="subtle">Updated {{ ticket.updated_at.strftime('%b %d, %Y %I:%M %p') }}</span>
              </div>
            </li>
            {% endfor %}
          </ul>
          {% else %}
          <p class="subtle">No support requests on fileâ€”great job keeping the network humming.</p>
          {% endif %}
        </article>
      </div>
    </section>
    {% elif active_section == 'customers' %}
    <section class="card" id="customers">
      <header class="section-header">
        <div>
          <h2>Add Customer</h2>
          <p class="subtle">Enroll a subscriber manually and optionally issue portal credentials.</p>
        </div>
      </header>
      <form
        class="stacked-form two-column"
        method="post"
        action="{{ url_for('create_client_admin', section='customers', status=request.args.get('status')) }}"
        enctype="multipart/form-data"
      >
        <label>
          Full name
          <input type="text" name="name" placeholder="Daisy Duke" required />
        </label>
        <label>
          Email
          <input type="email" name="email" placeholder="daisy@example.com" required />
        </label>
        <label>
          Company
          <input type="text" name="company" placeholder="DIXIELAND WIRELESS LLC" />
        </label>
        <label>
          Phone number
          <input type="tel" name="phone" placeholder="(334) 555-0100" required />
        </label>
        <label class="full-width">
          Service address
          <input type="text" name="address" placeholder="123 Main Street, Tallassee, AL" required />
        </label>
        {% if plan_field_config %}
        <div class="full-width plan-choice-card">
          <h3>Service plans</h3>
          <p class="subtle helper-text">
            Assign the residential, phone, and business packages tied to this account. Leave any category blank when it's
            not part of the subscription.
          </p>
          <div class="field-grid">
            {% for field in plan_field_config %}
            <label>
              {{ field.label }}
              <select name="{{ field.field }}">
                <option value="">No {{ field.category|lower }} plan</option>
                {% for plan in field.plans %}
                <option value="{{ plan.name }}">{{ plan.name }}{% if plan.price_cents %} ({{ plan.price_cents|currency }}/mo){% endif %}</option>
                {% endfor %}
              </select>
            </label>
            {% endfor %}
          </div>
          <div class="wifi-toggle admin">
            <span class="field-label">Provide managed Wi-Fi router?</span>
            <div class="toggle-options">
              <label class="toggle-option">
                <input type="radio" name="wifi_router_needed" value="yes" />
                <span>Yes</span>
              </label>
              <label class="toggle-option">
                <input type="radio" name="wifi_router_needed" value="no" checked />
                <span>No</span>
              </label>
            </div>
          </div>
        </div>
        {% endif %}
        <label>
          Driver's license number
          <input type="text" name="driver_license_number" placeholder="AL-9876543" required />
        </label>
        <label>
          Status
          <select name="status">
            {% for option in status_options %}
            <option value="{{ option }}" {% if option == 'New' %}selected{% endif %}>{{ option }}</option>
            {% endfor %}
          </select>
        </label>
        <label>
          Portal password (optional)
          <input type="password" name="password" minlength="8" placeholder="Generate a secure password" />
        </label>
        <label>
          Confirm password
          <input type="password" name="confirm_password" minlength="8" placeholder="Repeat password" />
        </label>
        <label class="file-input full-width">
          <span>Upload verification photo or PDF</span>
          <input type="file" name="verification_photo" accept=".jpg,.jpeg,.png,.heic,.heif,.pdf" />
        </label>
        <p class="subtle full-width helper-text">
          Adding contact details and an ID image keeps compliance, billing, and field teams aligned for every new subscriber.
        </p>
        <label class="full-width">
          Notes
          <textarea name="notes" rows="3" placeholder="Construction schedule, network specifics, or onboarding needs."></textarea>
        </label>
        <button class="button primary" type="submit">Create customer</button>
      </form>
    </section>
    <section class="card">
      <header class="section-header">
        <div>
          <h2>Customer Directory</h2>
          <p class="subtle">Track signup status, notes, and progress.</p>
        </div>
        <form method="get" class="filter-form" action="{{ url_for('dashboard') }}">
          <input type="hidden" name="section" value="customers" />
          <label>
            <span>Status</span>
            <select name="status" onchange="this.form.submit()">
              <option value="">All statuses</option>
              {% for option in status_options %}
              <option value="{{ option }}" {% if status_filter == option %}selected{% endif %}>{{ option }}</option>
              {% endfor %}
            </select>
          </label>
          {% if status_filter %}
          <a class="button link" href="{{ url_for('dashboard', section='customers') }}">Clear</a>
          {% endif %}
        </form>
      </header>
      {% if clients %}
      <div class="table-wrapper">
        <table>
          <thead>
            <tr>
              <th>Name</th>
              <th>Email</th>
              <th>Account #</th>
              <th>Service</th>
              <th>Contact &amp; Identity</th>
              <th>Status</th>
              <th>Notes</th>
              <th>Actions</th>
            </tr>
          </thead>
          <tbody>
            {% for client in clients %}
            <tr>
              <td>
                <strong>{{ client.name }}</strong>
                <div class="subtle">Joined {{ client.created_at.strftime('%b %d, %Y') }}</div>
              </td>
              <td>{{ client.email }}</td>
              <td><code>{{ client.account_reference }}</code></td>
              <td>
                {% if client.service_summary %}
                {{ client.service_summary }}
                {% else %}
                â€”
                {% endif %}
                <div class="subtle router-summary">
                  {% if client.wifi_router_needed %}
                  Router: Provided by DIXIELAND
                  {% else %}
                  Router: Customer supplied
                  {% endif %}
                </div>
              </td>
              <td class="contact-cell">
                <div class="customer-contact-grid">
                  <label>
                    <span>Phone</span>
                    <input
                      type="tel"
                      name="phone"
                      value="{{ client.phone or '' }}"
                      placeholder="(555) 555-0100"
                      form="client-status-{{ client.id }}"
                    />
                  </label>
                  <label class="full">
                    <span>Service address</span>
                    <textarea name="address" rows="2" placeholder="Enter service address" form="client-status-{{ client.id }}">{{ client.address or '' }}</textarea>
                  </label>
                  <label>
                    <span>Driver's license</span>
                    <input
                      type="text"
                      name="driver_license_number"
                      value="{{ client.driver_license_number or '' }}"
                      placeholder="AL-1234567"
                      form="client-status-{{ client.id }}"
                    />
                  </label>
                  <div class="full router-toggle">
                    <span>Managed Wi-Fi router</span>
                    <div class="toggle-options compact">
                      <label class="toggle-option small">
                        <input
                          type="radio"
                          name="wifi_router_needed"
                          value="yes"
                          form="client-status-{{ client.id }}"
                          {% if client.wifi_router_needed %}checked{% endif %}
                        />
                        <span>Yes</span>
                      </label>
                      <label class="toggle-option small">
                        <input
                          type="radio"
                          name="wifi_router_needed"
                          value="no"
                          form="client-status-{{ client.id }}"
                          {% if not client.wifi_router_needed %}checked{% endif %}
                        />
                        <span>No</span>
                      </label>
                    </div>
                  </div>
                </div>
                <div class="verification-panel">
                  {% if client.verification_photo_filename %}
                  <div class="verification-meta">
                    <a
                      class="button small ghost"
                      href="{{ url_for('client_verification_photo', client_id=client.id) }}"
                      target="_blank"
                      rel="noopener"
                    >
                      View photo
                    </a>
                    <span class="subtle">
                      Updated
                      {{ client.verification_photo_uploaded_at.strftime('%b %d, %Y') if client.verification_photo_uploaded_at else 'recently' }}
                    </span>
                  </div>
                  {% else %}
                  <p class="subtle">No verification photo on file.</p>
                  {% endif %}
                  <form
                    class="inline-form verification-upload"
                    method="post"
                    action="{{ url_for('upload_client_verification', client_id=client.id, section='customers', status=request.args.get('status')) }}"
                    enctype="multipart/form-data"
                  >
                    <label class="file-input small">
                      <span>Choose file</span>
                      <input type="file" name="verification_photo" accept=".jpg,.jpeg,.png,.heic,.heif,.pdf" required />
                    </label>
                    <button class="button small" type="submit">Upload</button>
                  </form>
                  {% if client.verification_photo_filename %}
                  <form
                    class="inline-form verification-remove"
                    method="post"
                    action="{{ url_for('upload_client_verification', client_id=client.id, section='customers', status=request.args.get('status')) }}"
                    onsubmit="return confirm('Remove the stored verification photo?');"
                  >
                    <input type="hidden" name="action" value="remove" />
                    <button class="button small danger" type="submit">Remove</button>
                  </form>
                  {% endif %}
                </div>
              </td>
              <td>
                <form id="client-status-{{ client.id }}" method="post" action="{{ url_for('update_client', client_id=client.id, section='customers', status=request.args.get('status')) }}">
                  <select name="status">
                    {% for option in status_options %}
                    <option value="{{ option }}" {% if client.status == option %}selected{% endif %}>{{ option }}</option>
                    {% endfor %}
                  </select>
                </form>
              </td>
              <td class="notes-cell">
                <textarea name="notes" rows="3" form="client-status-{{ client.id }}" placeholder="Add notes">{{ client.notes or '' }}</textarea>
              </td>
              <td class="action-cell">
                <button class="button small primary" type="submit" form="client-status-{{ client.id }}">Save</button>
                <form method="post" class="inline-form" action="{{ url_for('delete_client', client_id=client.id, section='customers', status=request.args.get('status')) }}" onsubmit="return confirm('Remove this client?');">
                  <button class="button small danger" type="submit">Delete</button>
                </form>
              </td>
            </tr>
            {% endfor %}
          </tbody>
        </table>
      </div>
      {% else %}
      <div class="empty-state">
        <h3>No customers yet</h3>
        <p>Send the public signup link or add a customer above to populate this list.</p>
      </div>
      {% endif %}
    </section>
    {% elif active_section == 'portal' %}
    <section class="card" id="portal">
      <header class="section-header">
        <div>
          <h2>Portal Credentials</h2>
          <p class="subtle">Issue and reset passwords for the customer portal.</p>
        </div>
      </header>
      {% if clients %}
      <div class="client-stack">
        {% for client in clients %}
        <article class="client-card">
          <header>
            <div>
              <h3>{{ client.name }}</h3>
              <p class="subtle">Account {{ client.account_reference }} Â· {{ client.email }}</p>
            </div>
            <span class="badge subtle">{{ client.status }}</span>
          </header>
          <div class="client-card-body">
            {% if client.portal_password_updated_at %}
            <p class="subtle">Password last updated {{ client.portal_password_updated_at.strftime('%b %d, %Y %I:%M %p') }}</p>
            {% else %}
            <p class="alert subtle">Password not issued yet.</p>
            {% endif %}
            <form class="stacked-form" method="post" action="{{ url_for('set_portal_password', client_id=client.id, section='portal', status=request.args.get('status')) }}">
              <label>
                New password
                <input type="password" name="password" minlength="8" placeholder="Create a secure password" required />
              </label>
              <label>
                Confirm password
                <input type="password" name="confirm_password" minlength="8" placeholder="Re-enter password" required />
              </label>
              <button class="button small primary" type="submit">Save password</button>
            </form>
            <form class="stacked-form" method="post" action="{{ url_for('reset_portal_password', client_id=client.id, section='portal', status=request.args.get('status')) }}">
              <button class="button small" type="submit">Generate temporary password</button>
            </form>
            <p class="subtle">Share the login URL: <a href="{{ url_for('portal_login', _external=True) }}" target="_blank" rel="noopener">Customer Portal</a>.</p>
          </div>
        </article>
        {% endfor %}
      </div>
      {% else %}
      <p class="subtle">Add customers first to enable portal management.</p>
      {% endif %}
    </section>
    {% elif active_section == 'billing' %}
    <section class="card" id="billing">
      <header class="section-header">
        <div>
          <h2>Billing Management</h2>
          <p class="subtle">Create and reconcile invoices for every subscriber.</p>
        </div>
      </header>
      {% if clients %}
      <div class="client-stack">
        {% for client in clients %}
        {% set outstanding_invoices = client.invoices | selectattr('status', 'in', ['Pending', 'Overdue']) | list %}
        {% set balance_cents = outstanding_invoices | map(attribute='amount_cents') | sum %}
        <article class="client-card">
          <header>
            <div>
              <h3>{{ client.name }}</h3>
              <p class="subtle">Account {{ client.account_reference }} Â· {{ client.email }}</p>
            </div>
            <div class="client-metrics">
              <span><strong>{{ client.invoices|length }}</strong> invoices</span>
              <span><strong>{{ balance_cents|currency }}</strong> due</span>
            </div>
          </header>
          <div class="client-card-body">
            <div class="record-list">
              {% if client.invoices %}
              {% for invoice in client.invoices | sort(attribute='created_at', reverse=True) %}
              <form class="record-row" method="post" action="{{ url_for('update_invoice', invoice_id=invoice.id, section='billing', status=request.args.get('status')) }}">
                <label>
                  Description
                  <input type="text" name="description" value="{{ invoice.description }}" required />
                </label>
                <label>
                  Amount ($)
                  <input type="number" step="0.01" min="0" name="amount" value="{{ invoice.amount_cents|cents_to_dollars }}" required />
                </label>
                <label>
                  Due date
                  <input type="date" name="due_date" value="{{ invoice.due_date.isoformat() if invoice.due_date }}" />
                </label>
                <label>
                  Status
                  <select name="status">
                    {% for option in invoice_status_options %}
                    <option value="{{ option }}" {% if invoice.status == option %}selected{% endif %}>{{ option }}</option>
                    {% endfor %}
                  </select>
                </label>
                <div class="record-actions">
                  <button class="button small primary" type="submit">Update</button>
                  <button class="button small danger" type="submit" form="delete-invoice-{{ invoice.id }}" onclick="return confirm('Delete this invoice?');">Delete</button>
                </div>
              </form>
              <form id="delete-invoice-{{ invoice.id }}" class="inline-form" method="post" action="{{ url_for('delete_invoice', invoice_id=invoice.id, section='billing', status=request.args.get('status')) }}"></form>
              {% endfor %}
              {% else %}
              <p class="subtle">No invoices recorded yet.</p>
              {% endif %}
            </div>
            <form class="stacked-form" method="post" action="{{ url_for('create_invoice', client_id=client.id, section='billing', status=request.args.get('status')) }}">
              <h4>New invoice</h4>
              <label>
                Description
                <input type="text" name="description" placeholder="Monthly service" required />
              </label>
              <label>
                Amount ($)
                <input type="number" step="0.01" min="0" name="amount" placeholder="79.99" required />
              </label>
              <label>
                Due date
                <input type="date" name="due_date" />
              </label>
              <label>
                Status
                <select name="status">
                  {% for option in invoice_status_options %}
                  <option value="{{ option }}" {% if option == 'Pending' %}selected{% endif %}>{{ option }}</option>
                  {% endfor %}
                </select>
              </label>
              <button class="button small primary" type="submit">Add invoice</button>
            </form>
          </div>
        </article>
        {% endfor %}
      </div>
      {% else %}
      <p class="subtle">Customers will appear here once they have been added to the directory.</p>
      {% endif %}
    </section>
    {% elif active_section == 'network' %}
    <section class="card" id="network">
      <header class="section-header">
        <div>
          <h2>Network Equipment</h2>
          <p class="subtle">Track every antenna, router, and install detail.</p>
        </div>
      </header>
      {% if clients %}
      <div class="client-stack">
        {% for client in clients %}
        <article class="client-card">
          <header>
            <div>
              <h3>{{ client.name }}</h3>
              <p class="subtle">Account {{ client.account_reference }} Â· {{ client.email }}</p>
            </div>
            <span class="badge subtle">{{ client.status }}</span>
          </header>
          <div class="client-card-body">
            <div class="record-list">
              {% if client.equipment %}
              {% for device in client.equipment | sort(attribute='created_at', reverse=True) %}
              <form class="record-row" method="post" action="{{ url_for('update_equipment', equipment_id=device.id, section='network', status=request.args.get('status')) }}">
                <label>
                  Name
                  <input type="text" name="name" value="{{ device.name }}" required />
                </label>
                <label>
                  Model
                  <input type="text" name="model" value="{{ device.model or '' }}" />
                </label>
                <label>
                  Serial
                  <input type="text" name="serial_number" value="{{ device.serial_number or '' }}" />
                </label>
                <label>
                  Installed
                  <input type="date" name="installed_on" value="{{ device.installed_on.isoformat() if device.installed_on }}" />
                </label>
                <label>
                  Notes
                  <input type="text" name="notes" value="{{ device.notes or '' }}" />
                </label>
                <div class="record-actions">
                  <button class="button small primary" type="submit">Update</button>
                  <button class="button small danger" type="submit" form="delete-equipment-{{ device.id }}" onclick="return confirm('Remove this equipment item?');">Delete</button>
                </div>
              </form>
              <form id="delete-equipment-{{ device.id }}" class="inline-form" method="post" action="{{ url_for('delete_equipment', equipment_id=device.id, section='network', status=request.args.get('status')) }}"></form>
              {% endfor %}
              {% else %}
              <p class="subtle">No equipment assigned yet.</p>
              {% endif %}
            </div>
            <form class="stacked-form" method="post" action="{{ url_for('create_equipment', client_id=client.id, section='network', status=request.args.get('status')) }}">
              <h4>Add equipment</h4>
              <label>
                Name
                <input type="text" name="name" placeholder="Subscriber Gateway" required />
              </label>
              <label>
                Model
                <input type="text" name="model" placeholder="UISP Wave AP" />
              </label>
              <label>
                Serial number
                <input type="text" name="serial_number" placeholder="SN123456" />
              </label>
              <label>
                Installed
                <input type="date" name="installed_on" />
              </label>
              <label>
                Notes
                <textarea name="notes" rows="2" placeholder="Mounted on roof, wired to PoE"></textarea>
              </label>
              <button class="button small primary" type="submit">Add equipment</button>
            </form>
          </div>
        </article>
        {% endfor %}
      </div>
      {% else %}
      <p class="subtle">Add customers to assign equipment and visualize your network footprint.</p>
      {% endif %}
    </section>
    {% elif active_section == 'appointments' %}
    <section class="card" id="appointments">
      <header class="section-header">
        <div>
          <h2>Field Appointments</h2>
          <p class="subtle">Coordinate installs, site surveys, and service calls.</p>
        </div>
        <div class="section-stats">
          <span class="metric-pill">Total {{ appointments_total }}</span>
          <span class="metric-pill warning">Pending {{ pending_appointments }}</span>
        </div>
      </header>
      <form
        class="stacked-form two-column"
        method="post"
        action="{{ url_for('create_appointment_admin', section='appointments', status=request.args.get('status')) }}"
      >
        <label>
          Customer
          <select name="client_id" required>
            <option value="">Select a customer</option>
            {% for customer in clients %}
            <option value="{{ customer.id }}">{{ customer.name }} ({{ customer.email }})</option>
            {% endfor %}
          </select>
        </label>
        <label>
          Title
          <input type="text" name="title" placeholder="Installation visit" required />
        </label>
        <label>
          Scheduled for
          <input type="datetime-local" name="scheduled_for" required />
        </label>
        <label>
          Assign technician
          <select name="technician_id">
            <option value="">Unassigned</option>
            {% for tech in technicians %}
            <option value="{{ tech.id }}">{{ tech.name }}{% if not tech.is_active %} (inactive){% endif %}</option>
            {% endfor %}
          </select>
        </label>
        <label>
          Internal notes
          <textarea name="notes" rows="3" placeholder="Technician name, prep steps, or gear required."></textarea>
        </label>
        <button class="button primary" type="submit">Schedule appointment</button>
      </form>
    </section>
    <section class="card" id="appointments-manage">
      <header class="section-header">
        <div>
          <h2>Manage schedule</h2>
          <p class="subtle">Review confirmations, reschedules, and completed visits.</p>
        </div>
      </header>
      {% if appointments %}
      <div class="table-wrapper">
        <table class="data-table appointment-table">
          <thead>
            <tr>
              <th>Details</th>
              <th>Schedule &amp; status</th>
              <th>Client feedback</th>
              <th>Actions</th>
            </tr>
          </thead>
          <tbody>
            {% for appointment in appointments %}
            <tr>
              <td>
                <strong>{{ appointment.title }}</strong>
                <div class="subtle">{{ appointment.client.name if appointment.client else 'Unassigned' }}</div>
                {% if appointment.technician %}
                <p class="subtle">Assigned to {{ appointment.technician.name }}</p>
                {% endif %}
                {% if appointment.notes %}
                <p class="subtle">{{ appointment.notes }}</p>
                {% endif %}
              </td>
              <td>
                <form
                  class="stacked-form compact"
                  method="post"
                  action="{{ url_for('update_appointment_admin', appointment_id=appointment.id, section='appointments', status=request.args.get('status')) }}"
                >
                  <label>
                    Scheduled for
                    <input type="datetime-local" name="scheduled_for" value="{{ appointment.scheduled_for.strftime('%Y-%m-%dT%H:%M') }}" />
                  </label>
                  {% if appointment.proposed_time %}
                  <div class="inline-note">
                    <strong>Proposed:</strong>
                    {{ appointment.proposed_time.strftime('%b %d, %Y %I:%M %p') }}
                    <label class="checkbox">
                      <input type="checkbox" name="use_proposed" />
                      <span>Apply proposed time</span>
                    </label>
                  </div>
                  {% endif %}
                  <label>
                    Status
                    <select name="status">
                      {% for option in appointment_status_options %}
                      <option value="{{ option }}" {% if appointment.status == option %}selected{% endif %}>{{ option }}</option>
                      {% endfor %}
                    </select>
                  </label>
                  <label>
                    Technician
                    <select name="technician_id">
                      <option value="">Unassigned</option>
                      {% for tech in technicians %}
                      <option value="{{ tech.id }}" {% if appointment.technician_id == tech.id %}selected{% endif %}>{{ tech.name }}</option>
                      {% endfor %}
                    </select>
                  </label>
                  <label>
                    Internal notes
                    <textarea name="notes" rows="2" placeholder="Share updates with the field team.">{{ appointment.notes or '' }}</textarea>
                  </label>
                  <div class="record-actions">
                    <button class="button small primary" type="submit">Update</button>
                  </div>
                </form>
              </td>
              <td>
                {% if appointment.client_message %}
                <p>{{ appointment.client_message }}</p>
                {% else %}
                <p class="subtle">No client feedback yet.</p>
                {% endif %}
              </td>
              <td>
                <form
                  class="inline-form"
                  method="post"
                  action="{{ url_for('delete_appointment_admin', appointment_id=appointment.id, section='appointments', status=request.args.get('status')) }}"
                  onsubmit="return confirm('Remove this appointment?');"
                >
                  <button class="button small danger" type="submit">Delete</button>
                </form>
              </td>
            </tr>
            {% endfor %}
          </tbody>
        </table>
      </div>
      {% else %}
      <p class="subtle">No appointments scheduled. Use the form above to add your first visit.</p>
      {% endif %}
    </section>
    {% elif active_section == 'field' %}
    <section class="card" id="field-ops">
      <header class="section-header">
        <div>
          <h2>Field Operations</h2>
          <p class="subtle">Coordinate technicians, installs, and required documentation.</p>
        </div>
        <div class="section-stats">
          <span class="metric-pill">Technicians {{ technicians|length }}</span>
          <span class="metric-pill warning">Visits {{ appointments|length }}</span>
          <span class="metric-pill">Photo uploads {{ recent_install_photos|length }}</span>
        </div>
      </header>
      <div class="field-grid">
        <form class="stacked-form" method="post" action="{{ url_for('create_technician_admin', section='field') }}">
          <h3>Create technician account</h3>
          <label>
            Name
            <input type="text" name="name" placeholder="Field Tech" required />
          </label>
          <label>
            Email
            <input type="email" name="email" placeholder="tech@example.com" required />
          </label>
          <label>
            Phone
            <input type="tel" name="phone" placeholder="555-123-4567" />
          </label>
          <label>
            Temporary password
            <input type="password" name="password" placeholder="At least 8 characters" required />
          </label>
          <button class="button primary" type="submit">Add technician</button>
          <p class="form-help subtle">Technicians use these credentials at <a href="{{ url_for('tech_login') }}" target="_blank">the field portal</a>.</p>
        </form>
        <div class="field-roster">
          <h3>Technician roster</h3>
          {% if technicians %}
          <div class="table-wrapper">
            <table class="data-table roster-table">
              <thead>
                <tr>
                  <th>Profile</th>
                  <th>Credentials</th>
                  <th>Actions</th>
                </tr>
              </thead>
              <tbody>
                {% for tech in technicians %}
                <tr>
                  <td>
                    <strong>{{ tech.name }}</strong>
                    <div class="subtle">{{ tech.phone or 'No phone on file' }}</div>
                    <span class="badge {% if tech.is_active %}badge-success{% else %}badge-muted{% endif %}">
                      {% if tech.is_active %}Active{% else %}Inactive{% endif %}
                    </span>
                  </td>
                  <td>
                    <form class="stacked-form compact" method="post" action="{{ url_for('update_technician_admin', technician_id=tech.id, section='field') }}">
                      <label>
                        Name
                        <input type="text" name="name" value="{{ tech.name }}" required />
                      </label>
                      <label>
                        Email
                        <input type="email" name="email" value="{{ tech.email }}" required />
                      </label>
                      <label>
                        Phone
                        <input type="tel" name="phone" value="{{ tech.phone or '' }}" />
                      </label>
                      <label class="checkbox">
                        <input type="checkbox" name="is_active" {% if tech.is_active %}checked{% endif %} />
                        <span>Active</span>
                      </label>
                      <label>
                        New password
                        <input type="password" name="new_password" placeholder="Leave blank to keep" />
                      </label>
                      <label>
                        Confirm password
                        <input type="password" name="confirm_password" placeholder="Confirm new password" />
                      </label>
                      <div class="record-actions">
                        <button class="button small primary" type="submit">Save</button>
                      </div>
                    </form>
                  </td>
                  <td>
                    <form
                      class="inline-form"
                      method="post"
                      action="{{ url_for('reset_technician_password', technician_id=tech.id, section='field') }}"
                    >
                      <button class="button small secondary" type="submit">Reset password</button>
                    </form>
                  </td>
                </tr>
                {% endfor %}
              </tbody>
            </table>
          </div>
          {% else %}
          <p class="subtle">No technicians yet. Create an account to unlock the mobile install portal.</p>
          {% endif %}
        </div>
      </div>
    </section>
    <section class="card" id="field-visits">
      <header class="section-header">
        <div>
          <h2>Upcoming visits</h2>
          <p class="subtle">Track assignments and photo requirements before sign-off.</p>
        </div>
      </header>
      {% if appointments %}
      <div class="table-wrapper">
        <table class="data-table">
          <thead>
            <tr>
              <th>Visit</th>
              <th>Schedule</th>
              <th>Photo checklist</th>
              <th>Quick links</th>
            </tr>
          </thead>
          <tbody>
            {% for appointment in appointments %}
            <tr>
              <td>
                <strong>{{ appointment.title }}</strong>
                <div class="subtle">{{ appointment.client.name if appointment.client else 'Unassigned' }}</div>
                <div class="subtle">Assigned to {{ appointment.technician.name if appointment.technician else 'Dispatch' }}</div>
              </td>
              <td>
                <div>{{ appointment.scheduled_for.strftime('%b %d, %Y %I:%M %p') }}</div>
                <span class="badge">{{ appointment.status }}</span>
              </td>
              <td>
                {% set missing = field_requirements.get(appointment.id) or [] %}
                {% if missing %}
                <ul class="checklist pending">
                  {% for category in missing %}
                  <li>{{ category }}</li>
                  {% endfor %}
                </ul>
                {% else %}
                <p class="subtle">All required photos uploaded.</p>
                {% endif %}
              </td>
              <td>
                <a class="button small secondary" href="{{ url_for('tech_appointment_detail', appointment_id=appointment.id) }}" target="_blank">Open in field portal</a>
              </td>
            </tr>
            {% endfor %}
          </tbody>
        </table>
      </div>
      {% else %}
      <p class="subtle">No upcoming field visits. Schedule an appointment to populate this view.</p>
      {% endif %}
    </section>
    <section class="card" id="field-photos">
      <header class="section-header">
        <div>
          <h2>Latest install photos</h2>
          <p class="subtle">Recent uploads from the technician portal appear here instantly.</p>
        </div>
      </header>
      {% if recent_install_photos %}
      <div class="photo-grid">
        {% for photo in recent_install_photos %}
        <figure class="photo-card">
          <a href="{{ url_for('serve_install_photo', photo_id=photo.id) }}" target="_blank">
            <img src="{{ url_for('serve_install_photo', photo_id=photo.id) }}" alt="{{ photo.category }} for {{ photo.client.name }}" />
          </a>
          <figcaption>
            <strong>{{ photo.category }}</strong>
            <span class="subtle">{{ photo.client.name if photo.client else 'Client' }}</span>
            <span class="subtle">{{ photo.uploaded_at.strftime('%b %d, %Y %I:%M %p') }}</span>
          </figcaption>
        </figure>
        {% endfor %}
      </div>
      {% else %}
      <p class="subtle">Once technicians upload install photos they will stream into this gallery.</p>
      {% endif %}
    </section>
    {% elif active_section == 'support' %}
    <section class="card" id="support">
      <header class="section-header">
        <div>
          <h2>Support Tickets</h2>
          <p class="subtle">Respond to subscriber questions and document resolutions.</p>
        </div>
      </header>
      <div class="snmp-settings-panel">
        <div class="snmp-settings-header">
          <h3>SNMP Relay Settings</h3>
          {% if snmp_settings.host %}
          <span class="status-pill status-active">Configured</span>
          {% else %}
          <span class="status-pill status-disabled">Not configured</span>
          {% endif %}
        </div>
        <p class="subtle">
          Provide the SNMP trap destination and identifiers used by your monitoring stack so DixieLand Wireless can
          send server-side email notifications when appointments, tickets, and alerts change.
        </p>
        <form
          class="stacked-form"
          method="post"
          action="{{ url_for('update_snmp_settings', section='support', status=request.args.get('status')) }}"
        >
          <div class="snmp-settings-grid">
            <label>
              Trap host
              <input type="text" name="host" placeholder="snmp-relay.example.com" value="{{ snmp_config.host if snmp_config else '' }}" />
            </label>
            <label>
              Port
              <input type="number" name="port" min="1" max="65535" value="{{ snmp_config.port if snmp_config else 162 }}" />
            </label>
            <label>
              Community string
              <input type="text" name="community" placeholder="public" value="{{ snmp_config.community if snmp_config else 'public' }}" />
            </label>
            <label>
              Enterprise OID
              <input type="text" name="enterprise_oid" placeholder="1.3.6.1.4.1.x" value="{{ snmp_config.enterprise_oid if snmp_config else '1.3.6.1.4.1.8072.9999' }}" />
            </label>
            <label>
              Admin email
              <input type="email" name="admin_email" placeholder="ops@example.com" value="{{ snmp_config.admin_email if snmp_config else '' }}" />
            </label>
          </div>
          <div class="snmp-settings-actions">
            <button class="button secondary" type="submit">Save SNMP settings</button>
          </div>
        </form>
      </div>
      <div class="snmp-email-panel">
        <div class="snmp-email-header">
          <h3>SNMP Email Relay</h3>
          {% if snmp_enabled %}
          <span class="status-pill status-active">Enabled</span>
          {% else %}
          <span class="status-pill status-disabled">Disabled</span>
          {% endif %}
        </div>
        <p class="subtle">
          Trigger a server-side email by emitting an SNMP trap. Populate the recipient, subject,
          and message body and the monitoring stack will deliver the notification.
        </p>
        <form class="stacked-form snmp-email-form" method="post" action="{{ url_for('send_snmp_email_admin') }}">
          <label>
            Recipient email
            <input type="email" name="recipient" list="client-emails" placeholder="customer@example.com" required />
          </label>
          <label>
            Subject
            <input type="text" name="subject" placeholder="Example: Maintenance window" required />
          </label>
          <label>
            Message
            <textarea name="body" rows="4" placeholder="Share details that will help the customer." required></textarea>
          </label>
          <button class="button primary" type="submit">Send SNMP email</button>
        </form>
        <datalist id="client-emails">
          {% for client in clients %}
          <option value="{{ client.email }}">{{ client.name }}</option>
          {% endfor %}
        </datalist>
        {% if not snmp_enabled %}
        <p class="snmp-email-warning subtle">
          Configure <code>SNMP_TRAP_HOST</code> or provide a <code>SNMP_EMAIL_SENDER</code> callable to activate delivery.
        </p>
        {% endif %}
      </div>
      <div class="down-detector-panel">
        <div class="down-detector-header">
          <h3>Down detector redirect</h3>
          {% if down_detector_config and down_detector_config.target_url %}
          <span class="status-pill status-active">Active</span>
          {% else %}
          <span class="status-pill status-disabled">Not set</span>
          {% endif %}
        </div>
        <p class="subtle">
          Choose the public status page customers should visit when selecting the down detector link from the
          website or client portal.
        </p>
        <form
          class="stacked-form"
          method="post"
          action="{{ url_for('update_down_detector_config', section='support', status=request.args.get('status')) }}"
        >
          <label>
            Target URL
            <input
              type="url"
              name="target_url"
              placeholder="https://status.example.com"
              value="{{ down_detector_config.target_url if down_detector_config else '' }}"
            />
          </label>
          <div class="snmp-settings-actions">
            <button class="button secondary" type="submit">Save redirect</button>
          </div>
        </form>
      </div>
      {% if clients %}
      <div class="client-stack">
        {% for client in clients %}
        <article class="client-card">
          <header>
            <div>
              <h3>{{ client.name }}</h3>
              <p class="subtle">Account {{ client.account_reference }} Â· {{ client.email }}</p>
            </div>
            <span class="badge subtle">{{ client.status }}</span>
          </header>
          <div class="client-card-body">
            <div class="record-list">
              {% if client.tickets %}
              {% for ticket in client.tickets | sort(attribute='created_at', reverse=True) %}
              <form class="record-row ticket-row" method="post" action="{{ url_for('update_ticket', ticket_id=ticket.id, section='support', status=request.args.get('status')) }}">
                <div class="ticket-meta">
                  <strong>{{ ticket.subject }}</strong>
                  <span class="subtle">Opened {{ ticket.created_at.strftime('%b %d, %Y %I:%M %p') }}</span>
                </div>
                <p class="ticket-message">{{ ticket.message }}</p>
                <label>
                  Status
                  <select name="status">
                    {% for option in ticket_status_options %}
                    <option value="{{ option }}" {% if ticket.status == option %}selected{% endif %}>{{ option }}</option>
                    {% endfor %}
                  </select>
                </label>
                <label>
                  Resolution notes
                  <textarea name="resolution_notes" rows="3" placeholder="Document updates shared with the client.">{{ ticket.resolution_notes or '' }}</textarea>
                </label>
                <div class="record-actions">
                  <button class="button small primary" type="submit">Update</button>
                  <button class="button small danger" type="submit" form="delete-ticket-{{ ticket.id }}" onclick="return confirm('Delete this ticket?');">Delete</button>
                </div>
              </form>
              <form id="delete-ticket-{{ ticket.id }}" class="inline-form" method="post" action="{{ url_for('delete_ticket', ticket_id=ticket.id, section='support', status=request.args.get('status')) }}"></form>
              {% endfor %}
              {% else %}
              <p class="subtle">No tickets submitted yet.</p>
              {% endif %}
            </div>
            <p class="subtle">Clients can open new tickets directly from their portal at any time.</p>
          </div>
        </article>
        {% endfor %}
      </div>
      {% else %}
      <p class="subtle">Once tickets arrive they'll appear organized here for easy follow-up.</p>
      {% endif %}
    </section>
    {% elif active_section == 'plans' %}
    <section class="card" id="plans">
      <header class="section-header">
        <div>
          <h2>Service Plans</h2>
          <p class="subtle">Curate residential, business, and phone offerings that appear on the public site and signup flow.</p>
        </div>
      </header>
      <datalist id="plan-category-suggestions">
        <option value="Residential"></option>
        <option value="Business"></option>
        <option value="Phone Service"></option>
      </datalist>
      <form class="plan-create-form" method="post" action="{{ url_for('create_service_plan_admin', section='plans') }}">
        <div class="field-grid">
          <label>
            Plan name
            <input type="text" name="name" placeholder="Wireless Internet" required />
          </label>
          <label>
            Category
            <input type="text" name="category" value="Residential" list="plan-category-suggestions" required />
          </label>
          <label>
            Price (USD/month)
            <input type="text" name="price" placeholder="69.99" required />
          </label>
          <label>
            Advertised speed
            <input type="text" name="speed" placeholder="Up to 150 Mbps" />
          </label>
        </div>
        <label>
          Description
          <textarea name="description" rows="3" placeholder="Summarize who this plan is perfect for."></textarea>
        </label>
        <label>
          Features (one per line)
          <textarea name="features" rows="4" placeholder="Unlimited data&#10;Managed Wi-Fi gateway"></textarea>
        </label>
        <div class="form-actions">
          <button class="button primary" type="submit">Add plan</button>
        </div>
      </form>
      <div class="plans-management">
        {% if service_plans_by_category %}
        {% for category, plans in service_plans_by_category %}
        <article class="plans-category-card card">
          <header>
            <h3>{{ category }} Plans</h3>
            <p class="subtle">Keep {{ category|lower }} subscribers informed with current pricing and benefits.</p>
          </header>
          {% for plan in plans %}
          <article class="plan-admin-card">
            <form class="stacked-form" method="post" action="{{ url_for('update_service_plan_admin', plan_id=plan.id, section='plans') }}">
              <div class="field-grid">
                <label>
                  Plan name
                  <input type="text" name="name" value="{{ plan.name }}" required />
                </label>
                <label>
                  Category
                  <input type="text" name="category" value="{{ plan.category }}" list="plan-category-suggestions" required />
                </label>
                <label>
                  Price (USD/month)
                  <input type="text" name="price" value="{{ plan.price_cents|cents_to_dollars }}" required />
                </label>
                <label>
                  Advertised speed
                  <input type="text" name="speed" value="{{ plan.speed or '' }}" />
                </label>
              </div>
              <label>
                Description
                <textarea name="description" rows="3">{{ plan.description or '' }}</textarea>
              </label>
              <label>
                Features (one per line)
                <textarea name="features" rows="4">{{ plan.feature_list | join('\n') }}</textarea>
              </label>
              <div class="form-actions">
                <button class="button primary" type="submit">Save changes</button>
                <button class="button danger" type="submit" form="delete-plan-{{ plan.id }}" onclick="return confirm('Delete this plan?');">Delete</button>
              </div>
            </form>
            <form id="delete-plan-{{ plan.id }}" class="inline-form" method="post" action="{{ url_for('delete_service_plan_admin', plan_id=plan.id, section='plans') }}"></form>
          </article>
          {% endfor %}
        </article>
        {% endfor %}
        {% else %}
        <p class="subtle">No plans are available yetâ€”add one to get started.</p>
        {% endif %}
      </div>
    </section>
    {% elif active_section == 'navigation' %}
    <section class="card" id="navigation">
      <header class="section-header">
        <div>
          <h2>Header Navigation</h2>
          <p class="subtle">Control the links that appear at the top of the public website.</p>
        </div>
      </header>
      <form class="nav-add-form" method="post" action="{{ url_for('add_navigation_item') }}">
        <div class="field-grid">
          <label>
            Link label
            <input type="text" name="label" placeholder="Example: Coverage Map" required />
          </label>
          <label>
            URL
            <input type="text" name="url" placeholder="https://example.com" required />
          </label>
        </div>
        <label class="checkbox">
          <input type="checkbox" name="open_in_new_tab" />
          <span>Open in new tab</span>
        </label>
        <button class="button small primary" type="submit">Add link</button>
      </form>
      <div class="navigation-list">
        {% if navigation_items %}
        {% for item in navigation_items %}
        <form class="navigation-item" method="post" action="{{ url_for('update_navigation_item', item_id=item.id) }}">
          <div class="field-grid">
            <label>
              Link label
              <input type="text" name="label" value="{{ item.label }}" required />
            </label>
            <label>
              URL
              <input type="text" name="url" value="{{ item.url }}" required />
            </label>
          </div>
          <label class="checkbox">
            <input type="checkbox" name="open_in_new_tab" {% if item.open_in_new_tab %}checked{% endif %} />
            <span>Open in new tab</span>
          </label>
          <div class="navigation-item-actions">
            <button class="button small primary" type="submit">Save</button>
            <button class="button small" type="submit" form="move-nav-{{ item.id }}-up">Move Up</button>
            <button class="button small" type="submit" form="move-nav-{{ item.id }}-down">Move Down</button>
            <button class="button small danger" type="submit" form="delete-nav-{{ item.id }}" onclick="return confirm('Remove this link from the header?');">Remove</button>
          </div>
        </form>
        <form id="move-nav-{{ item.id }}-up" class="inline-form" method="post" action="{{ url_for('move_navigation_item', item_id=item.id) }}">
          <input type="hidden" name="direction" value="up" />
        </form>
        <form id="move-nav-{{ item.id }}-down" class="inline-form" method="post" action="{{ url_for('move_navigation_item', item_id=item.id) }}">
          <input type="hidden" name="direction" value="down" />
        </form>
        <form id="delete-nav-{{ item.id }}" class="inline-form" method="post" action="{{ url_for('delete_navigation_item', item_id=item.id) }}"></form>
        {% endfor %}
        {% else %}
        <p class="subtle">No navigation links configured yet.</p>
        {% endif %}
      </div>
    </section>
    {% elif active_section == 'branding' %}
    <section class="card" id="branding">
      <header class="section-header compact">
        <div>
          <h2>Branding Assets</h2>
          <p class="subtle">Upload the latest logos, favicons, and wordmarks for DIXIELAND WIRELESS LLC.</p>
        </div>
      </header>
      <div class="branding-grid">
        {% for key, metadata in branding_asset_types.items() %}
        {% set asset = branding_assets.get(key) %}
        <article class="branding-asset">
          <header>
            <h3>{{ metadata.label }}</h3>
            <p>{{ metadata.description }}</p>
          </header>
          {% if asset %}
          <p class="subtle">Last updated {{ asset.uploaded_at.strftime('%b %d, %Y') }}</p>
          {% if key in ['logo', 'favicon', 'wordmark'] %}
          <div class="branding-preview-wrapper">
            <img class="branding-preview" src="{{ url_for('branding_file', asset_type=key) }}" alt="{{ metadata.label }} preview" />
          </div>
          {% endif %}
          {% else %}
          <p class="subtle">No file uploaded yet.</p>
          {% endif %}
          <form class="upload-form" method="post" action="{{ url_for('upload_branding') }}" enctype="multipart/form-data">
            <input type="hidden" name="asset_type" value="{{ key }}" />
            <label class="file-input">
              <span>Choose file</span>
              <input type="file" name="asset" required />
            </label>
            <button class="button small primary" type="submit">Upload</button>
          </form>
        </article>
        {% endfor %}
      </div>
    </section>
    {% elif active_section == 'blog' %}
    <section class="card" id="blog">
      <header class="section-header compact">
        <div>
          <h2>Blog Manager</h2>
          <p class="subtle">Share network updates, local announcements, and service tips with your customers.</p>
        </div>
      </header>
      <form class="stacked-form blog-create-form" method="post" action="{{ url_for('create_blog_post') }}">
        <h3>Write a new post</h3>
        <label>
          Title
          <input type="text" name="title" placeholder="Example: Network upgrades in Tallassee" required />
        </label>
        <label>
          Summary
          <textarea name="summary" rows="2" placeholder="Optional teaser that appears on the blog list."></textarea>
        </label>
        <label>
          Content
          <textarea name="content" rows="6" placeholder="Share the full update for your subscribers." required></textarea>
        </label>
        <label class="checkbox">
          <input type="checkbox" name="publish" />
          <span>Publish immediately</span>
        </label>
        <div class="blog-admin-actions">
          <button class="button primary" type="submit">Publish post</button>
        </div>
      </form>
      <div class="blog-admin-list">
        <h3>Existing posts</h3>
        {% if blog_posts %}
        {% for post in blog_posts %}
        <article class="blog-admin-card">
          <header class="blog-admin-header">
            <div>
              <h4>{{ post.title }}</h4>
              <p class="subtle">
                {% if post.is_published %}
                Published {{ (post.published_at or post.created_at).strftime('%b %d, %Y %I:%M %p') }}
                {% else %}
                Draft saved {{ post.updated_at.strftime('%b %d, %Y %I:%M %p') }}
                {% endif %}
              </p>
            </div>
            <span class="status-pill {% if post.is_published %}status-active{% else %}status-disabled{% endif %}">
              {% if post.is_published %}Published{% else %}Draft{% endif %}
            </span>
          </header>
          <div class="blog-admin-body">
            <form class="stacked-form" method="post" action="{{ url_for('update_blog_post', post_id=post.id) }}">
              <label>
                Title
                <input type="text" name="title" value="{{ post.title }}" required />
              </label>
              <label>
                Summary
                <textarea name="summary" rows="2" placeholder="Optional teaser.">{{ post.summary or '' }}</textarea>
              </label>
              <label>
                Content
                <textarea name="content" rows="6" required>{{ post.content }}</textarea>
              </label>
              <label class="checkbox">
                <input type="checkbox" name="publish" {% if post.is_published %}checked{% endif %} />
                <span>Visible on the public blog</span>
              </label>
              <div class="blog-admin-actions">
                <a class="button ghost" href="{{ url_for('blog_post', slug=post.slug) }}" target="_blank" rel="noopener">View</a>
                <button class="button secondary" type="submit">Save changes</button>
              </div>
            </form>
            <form
              class="inline-form"
              method="post"
              action="{{ url_for('delete_blog_post', post_id=post.id) }}"
              onsubmit="return confirm('Delete this post?');"
            >
              <button class="button small danger" type="submit">Delete</button>
            </form>
          </div>
        </article>
        {% endfor %}
        {% else %}
        <p class="subtle">No posts yet. Draft your first update to keep subscribers informed.</p>
        {% endif %}
      </div>
    </section>
    {% elif active_section == 'legal' %}
    <section class="card" id="legal">
      <header class="section-header compact">
        <div>
          <h2>Legal Document Library</h2>
          <p class="subtle">Upload the latest Acceptable Use Policy, Privacy Policy, and Terms of Service for your subscribers.</p>
        </div>
      </header>
      <div class="legal-documents-grid">
        {% for key, metadata in legal_document_types.items() %}
        {% set document = legal_documents[key] %}
        <article class="legal-document">
          <header>
            <h3>{{ metadata.label }}</h3>
            <p>{{ metadata.description }}</p>
          </header>
          {% if document %}
          <p class="subtle">Last updated {{ document.uploaded_at.strftime('%b %d, %Y') }}</p>
          <a class="button small" href="{{ url_for('download_document', doc_type=key) }}">Download current</a>
          {% else %}
          <p class="subtle">No file uploaded yet.</p>
          {% endif %}
          <form class="upload-form" method="post" action="{{ url_for('upload_document') }}" enctype="multipart/form-data">
            <input type="hidden" name="doc_type" value="{{ key }}" />
            <label class="file-input">
              <span>Choose file</span>
              <input type="file" name="document" required />
            </label>
            <button class="button small primary" type="submit">Upload</button>
          </form>
        </article>
        {% endfor %}
      </div>
    </section>
    {% endif %}
  </div>
</div>
{% endblock %}
