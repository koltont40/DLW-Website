{% extends "base.html" %}
{% block title %}{{ client.name }} Account | Admin Dashboard{% endblock %}
{% block content %}
<div class="dashboard-layout admin-account-layout">
  {% set account_url = url_for('admin_client_account', client_id=client.id) %}
  <aside class="admin-sidebar">
    <div class="sidebar-header">
      <h1>Customer Account</h1>
      <p class="subtle">Dive into {{ client.name }}'s subscription, billing, and field history.</p>
    </div>
    <nav class="sidebar-nav">
      <div class="sidebar-group">
        <span class="sidebar-group-label">Navigation</span>
        <a class="sidebar-link" href="{{ url_for('dashboard', section='customers') }}">Back to customers</a>
        <a
          class="sidebar-link"
          href="{{ url_for('dashboard', section='customers', focus=client.id) }}#customer-detail"
        >Open summary panel</a>
      </div>
      <div class="sidebar-group">
        <span class="sidebar-group-label">Quick actions</span>
        <a class="sidebar-link" href="mailto:{{ client.email }}">Email customer</a>
        {% if client.phone %}
        <a class="sidebar-link" href="tel:{{ client.phone }}">Call customer</a>
        {% endif %}
        {% if google_maps_url %}
        <a class="sidebar-link" href="{{ google_maps_url }}" target="_blank" rel="noopener">Google Maps</a>
        {% endif %}
        {% if apple_maps_url %}
        <a class="sidebar-link" href="{{ apple_maps_url }}" target="_blank" rel="noopener">Apple Maps</a>
        {% endif %}
      </div>
    </nav>
    <div class="sidebar-footer">
      <a class="button secondary" href="{{ url_for('logout') }}">Log out</a>
    </div>
  </aside>
  <div class="dashboard-main">
    <section class="card customer-detail-card">
      <header class="section-header customer-detail-header">
        <div>
          <h2>{{ client.name }}</h2>
          <p class="subtle">
            Account <code>{{ client.account_reference }}</code>
            {% if client.email %}
            • <a class="inline-link" href="mailto:{{ client.email }}">{{ client.email }}</a>
            {% endif %}
          </p>
        </div>
        <div class="customer-detail-actions">
          <span class="badge">{{ client.status }}</span>
          {% if portal_enabled %}
          <span class="badge success">Portal active</span>
          {% else %}
          <span class="badge warning">Portal pending</span>
          {% endif %}
          <span class="badge subtle">Joined {{ client.created_at.strftime('%b %d, %Y') }}</span>
        </div>
      </header>
      <div class="snapshot-grid">
        <article class="snapshot-tile">
          <header>
            <h3>Balance due</h3>
            <p class="metric-value">{{ outstanding_balance_cents|currency }}</p>
          </header>
          <p class="subtle">Based on unpaid invoices.</p>
        </article>
        <article class="snapshot-tile">
          <header>
            <h3>Upcoming due date</h3>
            <p class="metric-value">{{ upcoming_due_date|date_or_dash }}</p>
          </header>
          <p class="subtle">Soonest outstanding invoice.</p>
        </article>
        <article class="snapshot-tile">
          <header>
            <h3>Open tickets</h3>
            <p class="metric-value">{{ open_ticket_count }}</p>
          </header>
          <p class="subtle">Tickets waiting for resolution.</p>
        </article>
        <article class="snapshot-tile">
          <header>
            <h3>Active services</h3>
            <p class="metric-value">{{ service_groups|length }}</p>
          </header>
          <p class="subtle">Residential, business, or voice plans.</p>
        </article>
      </div>
      <div class="customer-detail-grid">
        <article class="detail-column">
          <h3>Contact &amp; Identity</h3>
          <dl class="detail-list">
            <div>
              <dt>Phone</dt>
              <dd>{{ client.phone or 'Not provided' }}</dd>
            </div>
            <div>
              <dt>Service address</dt>
              <dd>{{ client.address or 'Not provided' }}</dd>
            </div>
            <div>
              <dt>Driver license</dt>
              <dd>{{ client.driver_license_number or 'Not captured' }}</dd>
            </div>
          </dl>
          <div class="detail-actions">
            {% if client.phone %}
            <a class="button small ghost" href="tel:{{ client.phone }}">Call</a>
            {% endif %}
            <a class="button small ghost" href="mailto:{{ client.email }}">Email</a>
            {% if google_maps_url %}
            <a class="button small ghost" href="{{ google_maps_url }}" target="_blank" rel="noopener">Google Maps</a>
            {% endif %}
            {% if apple_maps_url %}
            <a class="button small ghost" href="{{ apple_maps_url }}" target="_blank" rel="noopener">Apple Maps</a>
            {% endif %}
            {% if client.verification_photo_filename %}
            <a
              class="button small ghost"
              href="{{ url_for('client_verification_photo', client_id=client.id) }}"
              target="_blank"
              rel="noopener"
            >View verification</a>
            {% endif %}
          </div>
          <div class="portal-management">
            <h4>Portal access</h4>
          {% if client.portal_password_updated_at %}
            <p class="subtle">Password last updated {{ client.portal_password_updated_at.strftime('%b %d, %Y %I:%M %p') }}</p>
          {% else %}
            <p class="alert subtle">Password not issued yet.</p>
          {% endif %}
          <form
            class="stacked-form"
            method="post"
            action="{{ url_for('set_portal_password', client_id=client.id, next=account_url) }}"
            >
              <label>
                New password
                <input type="password" name="password" minlength="8" placeholder="Create a secure password" required />
              </label>
              <label>
                Confirm password
                <input type="password" name="confirm_password" minlength="8" placeholder="Re-enter password" required />
              </label>
              <button class="button small primary" type="submit">Save password</button>
            </form>
            <form
              class="stacked-form"
              method="post"
              action="{{ url_for('reset_portal_password', client_id=client.id, next=account_url) }}"
            >
              <button class="button small" type="submit">Generate temporary password</button>
            </form>
            <p class="subtle">
              Share the login URL:
              <a href="{{ url_for('portal_login', _external=True) }}" target="_blank" rel="noopener">Customer Portal</a>.
            </p>
          </div>
          {% if client.notes %}
          <div class="detail-note">
            <h4>Account notes</h4>
            <p>{{ client.notes }}</p>
          </div>
          {% endif %}
        </article>
        <article class="detail-column">
          <h3>Service summary</h3>
          {% if service_groups %}
          <ul class="detail-pill-list">
            {% for label, plan in service_groups %}
            <li><span class="pill">{{ label }}</span> {{ plan }}</li>
            {% endfor %}
          </ul>
          {% else %}
          <p class="subtle">No service plans assigned yet.</p>
          {% endif %}
          <p class="subtle router-state">
            Managed Wi-Fi router:
            <strong>{% if client.wifi_router_needed %}Provided by DIXIELAND{% else %}Customer supplied{% endif %}</strong>
          </p>
          {% if equipment_items %}
          <h4>Installed equipment</h4>
          <ul class="detail-stack">
            {% for item in equipment_items %}
            <li>
              <div class="detail-primary">{{ item.name }}</div>
              <div class="detail-subtle">
                {{ item.model or 'Model pending' }} • {{ item.serial_number or 'Serial pending' }}
                {% if item.installed_on %} • Installed {{ item.installed_on.strftime('%b %d, %Y') }}{% endif %}
              </div>
              {% if item.notes %}
              <div class="detail-note">{{ item.notes }}</div>
              {% endif %}
            </li>
            {% endfor %}
          </ul>
          {% else %}
          <p class="subtle">No equipment on file.</p>
          {% endif %}
        </article>
        <article class="detail-column">
          <h3>Billing &amp; Support</h3>
          {% if invoices %}
          <h4>Invoices</h4>
          <ul class="detail-stack">
            {% for invoice in invoices %}
            <li>
              <div class="detail-primary">{{ invoice.description }}</div>
              <div class="detail-subtle">
                {{ invoice.status }} • {{ (invoice.amount_cents / 100) | currency }}
                {% if invoice.due_date %} • Due {{ invoice.due_date.strftime('%b %d, %Y') }}{% endif %}
              </div>
            </li>
            {% endfor %}
          </ul>
          {% else %}
          <p class="subtle">No invoices generated.</p>
          {% endif %}
          {% if tickets %}
          <h4>Recent tickets</h4>
          <ul class="detail-stack">
            {% for ticket in tickets[:4] %}
            <li>
              <div class="detail-primary">{{ ticket.subject }}</div>
              <div class="detail-subtle">{{ ticket.status }} • Priority {{ ticket.priority }} • {{ ticket.updated_at.strftime('%b %d, %Y %I:%M %p') }}</div>
            </li>
            {% endfor %}
          </ul>
          {% else %}
          <p class="subtle">No support tickets yet.</p>
          {% endif %}
          {% if upcoming_appointments %}
          <h4>Upcoming appointments</h4>
          <ul class="detail-stack">
            {% for appointment in upcoming_appointments %}
            <li>
              <div class="detail-primary">{{ appointment.title }}</div>
              <div class="detail-subtle">
                {{ appointment.status }} • {{ appointment.scheduled_for.strftime('%b %d, %Y %I:%M %p') }}
              </div>
            </li>
            {% endfor %}
          </ul>
          {% endif %}
        </article>
      </div>
    </section>

    <section class="card management-card" id="service-equipment">
      <header class="section-header">
        <div>
          <h3>Service plans &amp; equipment</h3>
          <p class="subtle">Assign subscription bundles and keep onsite hardware current.</p>
        </div>
      </header>
      <div class="management-grid">
        <article class="management-column">
          <h4>Service configuration</h4>
          {% if plan_field_config %}
          <form class="stacked-form" method="post" action="{{ url_for('update_client_service_plans', client_id=client.id) }}">
            <input type="hidden" name="next" value="{{ account_url }}" />
            {% for field in plan_field_config %}
            <label>
              {{ field.label }}
              <select name="{{ field.field }}">
                <option value="">No {{ field.label|lower }}</option>
                {% for plan in field.plans %}
                <option value="{{ plan.name }}" {% if field.selected == plan.name %}selected{% endif %}>
                  {{ plan.name }}{% if plan.speed %} • {{ plan.speed }}{% endif %}
                </option>
                {% endfor %}
              </select>
            </label>
            {% endfor %}
            <label>
              Account status
              <select name="status">
                {% for option in status_options %}
                <option value="{{ option }}" {% if client.status == option %}selected{% endif %}>{{ option }}</option>
                {% endfor %}
              </select>
            </label>
            <label class="checkbox">
              <input type="checkbox" name="wifi_router_needed" value="yes" {% if client.wifi_router_needed %}checked{% endif %} />
              <span>Managed Wi-Fi router provided by DIXIELAND</span>
            </label>
            <button class="button small primary" type="submit">Save service setup</button>
          </form>
          {% else %}
          <p class="subtle">
            No service plans are published yet. Create plans from the Service Plans section of the dashboard to assign them here.
          </p>
          {% endif %}
        </article>
        <article class="management-column">
          <h4>Installed equipment</h4>
          <div class="record-list">
            <h5>UISP managed devices</h5>
            {% if assigned_uisp_devices %}
            {% for device in assigned_uisp_devices %}
            <form class="record-row uisp-device-row" method="post" action="{{ url_for('assign_uisp_device', device_id=device.id) }}">
              <input type="hidden" name="next" value="{{ account_url }}" />
              <div class="uisp-device-overview">
                <div class="uisp-device-heading">
                  <strong>{{ device.nickname or device.name }}</strong>
                  <span class="badge {% if device.status == 'online' %}success{% elif device.status == 'offline' %}danger{% else %}subtle{% endif %}">
                    {{ device.status|capitalize }}
                  </span>
                </div>
                <div class="uisp-device-meta">
                  {% if device.model %}<span>{{ device.model }}</span>{% endif %}
                  {% if device.site_name %}<span>{{ device.site_name }}</span>{% endif %}
                  {% if device.tower %}<span>Tower · {{ device.tower.name }}</span>{% endif %}
                  {% if device.ip_address %}<span>IP {{ device.ip_address }}</span>{% endif %}
                  <span>Last seen {{ device.last_seen_at.strftime('%b %d, %Y %I:%M %p') if device.last_seen_at else 'Unknown' }}</span>
                </div>
              </div>
              <label class="inline-field">
                <span>Alias</span>
                <input type="text" name="nickname" value="{{ device.nickname or '' }}" placeholder="Roof sector AP" />
              </label>
              <label class="inline-field">
                <span>Tower</span>
                <select name="tower_id">
                  <option value="">No tower</option>
                  {% for tower in network_towers %}
                  <option value="{{ tower.id }}" {% if device.tower_id == tower.id %}selected{% endif %}>
                    {{ tower.name }}{% if tower.location %} — {{ tower.location }}{% endif %}
                  </option>
                  {% endfor %}
                </select>
              </label>
              <label class="inline-field">
                <span>Assignment</span>
                <select name="client_id">
                  <option value="">Unassigned</option>
                  <option value="{{ client.id }}" selected>Assign to {{ client.name }}</option>
                </select>
              </label>
              <label class="inline-field stretch">
                <span>Notes</span>
                <input type="text" name="notes" value="{{ device.notes or '' }}" placeholder="Mounting notes or install details" />
              </label>
              <div class="record-actions inline-actions">
                <button class="button small primary" type="submit">Save</button>
              </div>
            </form>
            {% endfor %}
            {% else %}
            <p class="subtle">No UISP devices assigned to this account.</p>
            {% endif %}
            {% if available_uisp_devices %}
            <h6>Available UISP devices</h6>
            {% for device in available_uisp_devices %}
            <form class="record-row uisp-device-row" method="post" action="{{ url_for('assign_uisp_device', device_id=device.id) }}">
              <input type="hidden" name="next" value="{{ account_url }}" />
              <input type="hidden" name="client_id" value="{{ client.id }}" />
              <div class="uisp-device-overview">
                <div class="uisp-device-heading">
                  <strong>{{ device.nickname or device.name }}</strong>
                  <span class="badge subtle">Unassigned</span>
                </div>
                <div class="uisp-device-meta">
                  {% if device.model %}<span>{{ device.model }}</span>{% endif %}
                  {% if device.site_name %}<span>{{ device.site_name }}</span>{% endif %}
                  {% if device.tower %}<span>Tower · {{ device.tower.name }}</span>{% endif %}
                  {% if device.ip_address %}<span>IP {{ device.ip_address }}</span>{% endif %}
                  <span>Last seen {{ device.last_seen_at.strftime('%b %d, %Y %I:%M %p') if device.last_seen_at else 'Unknown' }}</span>
                </div>
              </div>
              <label class="inline-field">
                <span>Alias</span>
                <input type="text" name="nickname" placeholder="Assign alias" />
              </label>
              <label class="inline-field">
                <span>Tower</span>
                <select name="tower_id">
                  <option value="">No tower</option>
                  {% for tower in network_towers %}
                  <option value="{{ tower.id }}">{{ tower.name }}{% if tower.location %} — {{ tower.location }}{% endif %}</option>
                  {% endfor %}
                </select>
              </label>
              <label class="inline-field stretch">
                <span>Notes</span>
                <input type="text" name="notes" placeholder="Mounting notes or install details" />
              </label>
              <div class="record-actions inline-actions">
                <button class="button small primary" type="submit">Assign to {{ client.name }}</button>
              </div>
            </form>
            {% endfor %}
            {% endif %}
            {% if equipment_items %}
            {% for item in equipment_items %}
            <form class="record-row" method="post" action="{{ url_for('update_equipment', equipment_id=item.id) }}">
              <input type="hidden" name="next" value="{{ account_url }}" />
              <label>
                Name
                <input type="text" name="name" value="{{ item.name }}" required />
              </label>
              <label>
                Model
                <input type="text" name="model" value="{{ item.model or '' }}" />
              </label>
              <label>
                Serial number
                <input type="text" name="serial_number" value="{{ item.serial_number or '' }}" />
              </label>
              <label>
                Installed
                <input type="date" name="installed_on" value="{{ item.installed_on.isoformat() if item.installed_on }}" />
              </label>
              <label>
                Notes
                <textarea name="notes" rows="2" placeholder="Mounting notes or install details">{{ item.notes or '' }}</textarea>
              </label>
              <div class="record-actions">
                <button class="button small primary" type="submit">Update</button>
                <button class="button small danger" type="submit" form="delete-equipment-{{ item.id }}" onclick="return confirm('Remove this equipment item?');">Delete</button>
              </div>
            </form>
            <form id="delete-equipment-{{ item.id }}" class="inline-form" method="post" action="{{ url_for('delete_equipment', equipment_id=item.id) }}">
              <input type="hidden" name="next" value="{{ account_url }}" />
            </form>
            {% endfor %}
            {% else %}
            <p class="subtle">No equipment has been recorded for this account.</p>
            {% endif %}
          </div>
          <form class="stacked-form" method="post" action="{{ url_for('create_equipment', client_id=client.id) }}">
            <input type="hidden" name="next" value="{{ account_url }}" />
            <h5>Add equipment</h5>
            <label>
              Name
              <input type="text" name="name" placeholder="Subscriber Gateway" required />
            </label>
            <label>
              Model
              <input type="text" name="model" placeholder="UISP Wave AP" />
            </label>
            <label>
              Serial number
              <input type="text" name="serial_number" placeholder="SN123456" />
            </label>
            <label>
              Installed
              <input type="date" name="installed_on" />
            </label>
            <label>
              Notes
              <textarea name="notes" rows="2" placeholder="Mounting location, cabling notes, etc."></textarea>
            </label>
            <button class="button small primary" type="submit">Add equipment</button>
          </form>
        </article>
      </div>
    </section>

    <section class="card management-card" id="billing-management">
      <header class="section-header">
        <div>
          <h3>Billing management</h3>
          <p class="subtle">Issue invoices and keep balances in sync.</p>
        </div>
      </header>
      <div class="management-grid">
        <article class="management-column">
          <h4>Invoices</h4>
          <div class="record-list">
            {% if invoices %}
            {% for invoice in invoices %}
            <form class="record-row" method="post" action="{{ url_for('update_invoice', invoice_id=invoice.id) }}">
              <input type="hidden" name="next" value="{{ account_url }}" />
              <label>
                Description
                <input type="text" name="description" value="{{ invoice.description }}" required />
              </label>
              <label>
                Amount ($)
                <input type="number" name="amount" step="0.01" min="0" value="{{ '%.2f'|format(invoice.amount_cents / 100) }}" required />
              </label>
              <label>
                Due date
                <input type="date" name="due_date" value="{{ invoice.due_date.isoformat() if invoice.due_date }}" />
              </label>
              <label>
                Status
                <select name="status">
                  {% for option in invoice_status_options %}
                  <option value="{{ option }}" {% if invoice.status == option %}selected{% endif %}>{{ option }}</option>
                  {% endfor %}
                </select>
              </label>
              <div class="record-actions">
                <button class="button small primary" type="submit">Update</button>
                <button class="button small danger" type="submit" form="delete-invoice-{{ invoice.id }}" onclick="return confirm('Delete this invoice?');">Delete</button>
              </div>
            </form>
            <form id="delete-invoice-{{ invoice.id }}" class="inline-form" method="post" action="{{ url_for('delete_invoice', invoice_id=invoice.id) }}">
              <input type="hidden" name="next" value="{{ account_url }}" />
            </form>
            {% endfor %}
            {% else %}
            <p class="subtle">No invoices generated yet.</p>
            {% endif %}
          </div>
        </article>
        <article class="management-column">
          <h4>Create invoice</h4>
          <form class="stacked-form" method="post" action="{{ url_for('create_invoice', client_id=client.id) }}">
            <input type="hidden" name="next" value="{{ account_url }}" />
            <label>
              Description
              <input type="text" name="description" placeholder="Monthly service" required />
            </label>
            <label>
              Amount ($)
              <input type="number" name="amount" step="0.01" min="0" placeholder="79.99" required />
            </label>
            <label>
              Due date
              <input type="date" name="due_date" />
            </label>
            <label>
              Status
              <select name="status">
                {% for option in invoice_status_options %}
                <option value="{{ option }}" {% if option == 'Pending' %}selected{% endif %}>{{ option }}</option>
                {% endfor %}
              </select>
            </label>
            <button class="button small primary" type="submit">Add invoice</button>
          </form>
        </article>
        <article class="management-column autopay-management">
          {% set default_method = client.default_payment_method() %}
          <h4>Autopay &amp; cards</h4>
          <p class="subtle">
            Billing status: {{ client.billing_status }}{% if client.service_suspended %} • Service is currently suspended until payment is received{% endif %}
          </p>
          <div class="payment-method-list">
            {% if payment_methods %}
            {% for method in payment_methods %}
            <div class="payment-method-row">
              <div>
                <strong>{{ method.describe() }}</strong>
                <p class="subtle">Expires {{ "%02d"|format(method.exp_month) }}/{{ method.exp_year }}{% if method.cardholder_name %} • {{ method.cardholder_name }}{% endif %}</p>
              </div>
              <div class="payment-actions">
                {% if method.is_default %}
                <span class="badge success">Default</span>
                {% else %}
                <form method="post" action="{{ url_for('make_default_payment_method', method_id=method.id) }}">
                  <input type="hidden" name="next" value="{{ account_url }}" />
                  <button class="button small secondary" type="submit">Make default</button>
                </form>
                {% endif %}
                <form method="post" action="{{ url_for('delete_payment_method', method_id=method.id) }}" onsubmit="return confirm('Remove this payment method?');">
                  <input type="hidden" name="next" value="{{ account_url }}" />
                  <button class="button small danger" type="submit">Remove</button>
                </form>
              </div>
            </div>
            {% endfor %}
            {% else %}
            <p class="subtle">No payment methods on file.</p>
            {% endif %}
          </div>
          {% if stripe_ready and stripe_publishable_key %}
          <div class="admin-card-controls">
            <button class="button small primary" type="button" id="admin-add-card">Add card</button>
          </div>
          <div class="admin-card-form hidden" id="admin-card-form">
            <div id="admin-card-element" class="admin-card-element"></div>
            <label class="checkbox-inline">
              <input type="checkbox" id="admin-set-default" {% if not payment_methods %}checked{% endif %} />
              Set as default for autopay
            </label>
            <p class="form-help" id="admin-card-errors"></p>
            <div class="button-row">
              <button class="button small primary" type="button" id="admin-save-card">Save card</button>
              <button class="button small secondary" type="button" id="admin-cancel-card">Cancel</button>
            </div>
          </div>
          {% endif %}
          {% if stripe_ready %}
          <form class="stacked-form autopay-add-form" method="post" action="{{ url_for('add_payment_method', client_id=client.id) }}">
            <input type="hidden" name="next" value="{{ account_url }}" />
            <label>
              Stripe payment method ID
              <input type="text" name="stripe_payment_method_id" placeholder="pm_12345" required />
            </label>
            <label class="checkbox-inline">
              <input type="checkbox" name="set_default" {% if not payment_methods %}checked{% endif %} />
              Set as default for autopay
            </label>
            <button class="button small primary" type="submit">Attach payment method</button>
            <p class="form-help">Admins can paste a payment method ID from Stripe or use the add card tool above.</p>
          </form>
          {% else %}
          <p class="subtle">Configure Stripe to attach payment methods or direct the customer to the portal.</p>
          {% endif %}
          <form class="stacked-form autopay-toggle" method="post" action="{{ url_for('configure_autopay', client_id=client.id) }}">
            <input type="hidden" name="next" value="{{ account_url }}" />
            {% if client.autopay_enabled %}
            <p class="subtle">Autopay charges {{ default_method.describe() if default_method else 'the default card' }} on invoice due dates.</p>
            <button class="button small danger" type="submit" name="action" value="disable">Disable autopay</button>
            {% else %}
            <p class="subtle">Enable autopay to automatically collect balances when they are due.</p>
            {% if payment_methods %}
            <label>
              Use card
              <select name="payment_method_id">
                {% for method in payment_methods %}
                <option value="{{ method.id }}" {% if method.is_default %}selected{% endif %}>{{ method.describe() }} • Exp {{ "%02d"|format(method.exp_month) }}/{{ method.exp_year }}</option>
                {% endfor %}
              </select>
            </label>
            <button class="button small primary" type="submit">Enable autopay</button>
            {% else %}
            <p class="subtle">Add a payment method to enable autopay.</p>
            <button class="button small primary" type="submit" disabled>Enable autopay</button>
            {% endif %}
            {% endif %}
          </form>
        </article>
      </div>
    </section>

    <section class="card management-card" id="appointment-management">
      <header class="section-header">
        <div>
          <h3>Appointments &amp; schedule</h3>
          <p class="subtle">Coordinate visits and respond to customer requests.</p>
        </div>
      </header>
      <div class="management-grid">
        <article class="management-column">
          <h4>Schedule visit</h4>
          <form class="stacked-form" method="post" action="{{ url_for('create_appointment_admin') }}">
            <input type="hidden" name="next" value="{{ account_url }}" />
            <input type="hidden" name="client_id" value="{{ client.id }}" />
            <label>
              Title
              <input type="text" name="title" placeholder="Installation visit" required />
            </label>
            <label>
              Scheduled for
              <input type="datetime-local" name="scheduled_for" required />
            </label>
            <label>
              Assign technician
              <select name="technician_id">
                <option value="">Unassigned</option>
                {% for tech in technicians %}
                <option value="{{ tech.id }}">{{ tech.name }}{% if not tech.is_active %} (inactive){% endif %}</option>
                {% endfor %}
              </select>
            </label>
            <label>
              Internal notes
              <textarea name="notes" rows="3" placeholder="Prep steps, tools, or context."></textarea>
            </label>
            <button class="button small primary" type="submit">Schedule appointment</button>
          </form>
        </article>
        <article class="management-column">
          <h4>Manage appointments</h4>
          <div class="record-list">
            {% if appointments %}
            {% for appointment in appointments %}
            <form class="record-row" method="post" action="{{ url_for('update_appointment_admin', appointment_id=appointment.id) }}">
              <input type="hidden" name="next" value="{{ account_url }}" />
              <div>
                <strong>{{ appointment.title }}</strong>
                <p class="subtle">Status: {{ appointment.status }}{% if appointment.technician %} • {{ appointment.technician.name }}{% endif %}</p>
                <p class="subtle">Scheduled {{ appointment.scheduled_for.strftime('%b %d, %Y %I:%M %p') }}</p>
                {% if appointment.client_message %}
                <p class="subtle">Customer message: {{ appointment.client_message }}</p>
                {% endif %}
              </div>
              <label>
                Scheduled for
                <input type="datetime-local" name="scheduled_for" value="{{ appointment.scheduled_for.strftime('%Y-%m-%dT%H:%M') }}" />
              </label>
              {% if appointment.proposed_time %}
              <div class="inline-note">
                Proposed: {{ appointment.proposed_time.strftime('%b %d, %Y %I:%M %p') }}
                <label class="checkbox">
                  <input type="checkbox" name="use_proposed" />
                  <span>Use proposed time</span>
                </label>
              </div>
              {% endif %}
              <label>
                Status
                <select name="status">
                  {% for option in appointment_status_options %}
                  <option value="{{ option }}" {% if appointment.status == option %}selected{% endif %}>{{ option }}</option>
                  {% endfor %}
                </select>
              </label>
              <label>
                Technician
                <select name="technician_id">
                  <option value="">Unassigned</option>
                  {% for tech in technicians %}
                  <option value="{{ tech.id }}" {% if appointment.technician_id == tech.id %}selected{% endif %}>{{ tech.name }}</option>
                  {% endfor %}
                </select>
              </label>
              <label>
                Internal notes
                <textarea name="notes" rows="3">{{ appointment.notes or '' }}</textarea>
              </label>
              <div class="record-actions">
                <button class="button small primary" type="submit">Update</button>
                <button class="button small danger" type="submit" form="delete-appointment-{{ appointment.id }}" onclick="return confirm('Remove this appointment?');">Delete</button>
              </div>
            </form>
            <form id="delete-appointment-{{ appointment.id }}" class="inline-form" method="post" action="{{ url_for('delete_appointment_admin', appointment_id=appointment.id) }}">
              <input type="hidden" name="next" value="{{ account_url }}" />
            </form>
            {% endfor %}
            {% else %}
            <p class="subtle">No appointments scheduled for this account.</p>
            {% endif %}
          </div>
        </article>
      </div>
    </section>

    <section class="card">
      <header class="section-header">
        <div>
          <h3>Support ticket history</h3>
          <p class="subtle">Full timeline with attachments and priority.</p>
        </div>
      </header>
      {% if tickets %}
      <ul class="detail-stack">
        {% for ticket in tickets %}
        <li>
          <div class="detail-primary">{{ ticket.subject }}</div>
          <div class="detail-subtle">
            {{ ticket.status }} • Priority {{ ticket.priority }} • Opened {{ ticket.created_at.strftime('%b %d, %Y %I:%M %p') }}
          </div>
          <p>{{ ticket.message }}</p>
          {% if ticket.attachments %}
          <div class="photo-chip-group">
            {% for attachment in ticket.attachments %}
            <a
              href="{{ url_for('serve_ticket_attachment', attachment_id=attachment.id) }}"
              target="_blank"
              rel="noopener"
            >{{ attachment.original_filename }}</a>
            {% endfor %}
          </div>
          {% endif %}
          {% if ticket.resolution_notes %}
          <p class="subtle">Resolution notes: {{ ticket.resolution_notes }}</p>
          {% endif %}
        </li>
        {% endfor %}
      </ul>
      {% else %}
      <p class="subtle">No support interaction history for this account.</p>
      {% endif %}
    </section>

    <section class="card">
      <header class="section-header">
        <div>
          <h3>Appointment timeline</h3>
          <p class="subtle">Track field visits and confirmations.</p>
        </div>
      </header>
      {% if appointments %}
      <ul class="detail-stack">
        {% for appointment in appointments %}
        <li>
          <div class="detail-primary">{{ appointment.title }}</div>
          <div class="detail-subtle">
            {{ appointment.status }} • {{ appointment.scheduled_for.strftime('%b %d, %Y %I:%M %p') }}
            {% if appointment.technician %} • {{ appointment.technician.name }}{% endif %}
          </div>
          {% if appointment.notes %}
          <p class="subtle">Tech notes: {{ appointment.notes }}</p>
          {% endif %}
          {% if appointment.client_message %}
          <p class="subtle">Customer message: {{ appointment.client_message }}</p>
          {% endif %}
        </li>
        {% endfor %}
      </ul>
      {% else %}
      <p class="subtle">No appointments recorded.</p>
      {% endif %}
    </section>

    <section class="card">
      <header class="section-header">
        <div>
          <h3>Install documentation</h3>
          {% if missing_photo_categories %}
          <p class="alert subtle">Missing categories: {{ missing_photo_categories | join(', ') }}</p>
          {% else %}
          <p class="subtle">All required photo categories are on file.</p>
          {% endif %}
        </div>
      </header>
      <div class="detail-photo-grid">
        {% for category in install_photo_categories %}
        {% set photos = photo_map.get(category) %}
        <article class="detail-photo-item {% if photos %}complete{% else %}missing{% endif %}">
          <h4>{{ category }}</h4>
          {% if photos %}
          <div class="photo-chip-group">
            {% for photo in photos %}
            <a href="{{ url_for('serve_install_photo', photo_id=photo.id) }}" target="_blank" rel="noopener">View</a>
            {% endfor %}
          </div>
          {% else %}
          <p class="subtle">Upload needed</p>
          {% endif %}
        </article>
        {% endfor %}
        {% for category, photos in photo_map.items() if category not in install_photo_categories and photos %}
        <article class="detail-photo-item optional">
          <h4>{{ category }}</h4>
          <div class="photo-chip-group">
            {% for photo in photos %}
            <a href="{{ url_for('serve_install_photo', photo_id=photo.id) }}" target="_blank" rel="noopener">View</a>
            {% endfor %}
          </div>
        </article>
        {% endfor %}
      </div>
    </section>
</div>
</div>
{% if stripe_ready and stripe_publishable_key %}
<script src="https://js.stripe.com/v3/"></script>
<script>
  (() => {
    const publishableKey = {{ stripe_publishable_key|tojson }};
    const loginRedirect = "{{ url_for('login', next=account_url) }}";
    if (!publishableKey) {
      return;
    }
    const addButton = document.getElementById("admin-add-card");
    const formWrapper = document.getElementById("admin-card-form");
    const saveButton = document.getElementById("admin-save-card");
    const cancelButton = document.getElementById("admin-cancel-card");
    const errorField = document.getElementById("admin-card-errors");
    const cardContainer = document.getElementById("admin-card-element");
    const setDefaultInput = document.getElementById("admin-set-default");
    if (!addButton || !formWrapper || !saveButton || !cancelButton || !errorField || !cardContainer) {
      return;
    }

    const stripe = Stripe(publishableKey);
    const elements = stripe.elements();
    const cardElement = elements.create("card");
    const cardholderDetails = {
      name: {{ client.name|tojson }},
      email: {{ client.email|tojson }},
    };
    let setupSecret = null;
    let mounted = false;
    let processing = false;

    const updateSaveState = () => {
      saveButton.disabled = processing || !setupSecret;
    };

    const openForm = async () => {
      formWrapper.classList.remove("hidden");
      errorField.textContent = "";
      if (!mounted) {
        cardElement.mount("#admin-card-element");
        mounted = true;
      }
      setupSecret = null;
      processing = false;
      updateSaveState();
      try {
        const response = await fetch(
          "{{ url_for('admin_payment_method_setup_intent', client_id=client.id) }}",
          {
            credentials: "include",
            headers: {
              Accept: "application/json",
              "X-Requested-With": "XMLHttpRequest",
            },
          }
        );
        if (response.status === 401) {
          window.location.href = loginRedirect;
          return;
        }
        const data = await response.json().catch(() => ({}));
        if (!response.ok || data.error || !data.client_secret) {
          throw new Error(data.error || "Unable to prepare card entry. Please try again.");
        }
        setupSecret = data.client_secret;
      } catch (err) {
        setupSecret = null;
        errorField.textContent = err.message || "Unable to prepare card entry.";
      }
      updateSaveState();
    };

    const closeForm = () => {
      formWrapper.classList.add("hidden");
      setupSecret = null;
      cardElement.clear();
      errorField.textContent = "";
      processing = false;
      updateSaveState();
    };

    addButton.addEventListener("click", (event) => {
      event.preventDefault();
      openForm();
    });

    cancelButton.addEventListener("click", (event) => {
      event.preventDefault();
      closeForm();
    });

    saveButton.addEventListener("click", async (event) => {
      event.preventDefault();
      if (!setupSecret) {
        errorField.textContent = "We're getting things ready. Please try saving the card again.";
        return;
      }
      processing = true;
      updateSaveState();
      errorField.textContent = "";
      const billingDetails = {};
      if (cardholderDetails.name) {
        billingDetails.name = cardholderDetails.name;
      }
      if (cardholderDetails.email) {
        billingDetails.email = cardholderDetails.email;
      }
      let confirmation;
      try {
        confirmation = await stripe.confirmCardSetup(
          setupSecret,
          {
            payment_method: {
              card: cardElement,
              billing_details: billingDetails,
            },
            redirect: "if_required",
          }
        );
      } catch (err) {
        errorField.textContent = err.message || "Unable to save card.";
        processing = false;
        updateSaveState();
        return;
      }
      if (confirmation.error) {
        errorField.textContent = confirmation.error.message || "Unable to save card.";
        processing = false;
        updateSaveState();
        return;
      }
      const setupIntent = confirmation.setupIntent;
      const setupStatus = setupIntent ? setupIntent.status : null;
      if (
        !setupIntent ||
        !setupIntent.payment_method ||
        (setupStatus !== "succeeded" && setupStatus !== "processing")
      ) {
        errorField.textContent =
          "Stripe did not confirm the card. Please try again.";
        processing = false;
        updateSaveState();
        return;
      }
      try {
        const response = await fetch("{{ url_for('add_payment_method', client_id=client.id) }}", {
          method: "POST",
          credentials: "include",
          headers: {
            "Content-Type": "application/json",
            Accept: "application/json",
            "X-Requested-With": "XMLHttpRequest",
          },
          body: JSON.stringify({
            payment_method_id: setupIntent.payment_method,
            set_default: setDefaultInput ? setDefaultInput.checked : true,
          }),
        });
        if (response.status === 401) {
          window.location.href = loginRedirect;
          return;
        }
        const payload = await response.json().catch(() => ({}));
        if (!response.ok || payload.error) {
          throw new Error(payload.error || "Unable to save card. Please try again.");
        }
        window.location.reload();
      } catch (err) {
        errorField.textContent = err.message || "Unable to save card.";
        processing = false;
        updateSaveState();
      }
    });
  })();
</script>
{% endif %}
{% endblock %}
